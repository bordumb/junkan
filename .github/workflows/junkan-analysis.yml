name: jnkn Impact Analysis

on:
  pull_request:
    types: [opened, synchronize]

permissions:
  contents: read
  pull-requests: write  # Needed to post comments

jobs:
  analyze:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Important: Fetch history for diffs

      - name: Install uv
        uses: astral-sh/setup-uv@v1

      - name: Set up Python
        run: uv python install 3.12

      - name: Install jnkn
        run: uv sync

      - name: Build Dependency Graph
        # In a real setup, you might fetch a cached graph from main.
        # For now, we scan fresh.
        run: uv run jnkn ingest --code-dir .

      - name: Get Changed Files
        id: changes
        run: |
          # Get list of changed files in this PR
          # We filter for .py files for this demo
          CHANGED=$(git diff --name-only origin/${{ github.base_ref }} HEAD | grep .py | xargs)
          echo "files=$CHANGED" >> $GITHUB_OUTPUT

      - name: Calculate Blast Radius
        if: steps.changes.outputs.files != ''
        id: blast
        # Pass the changed files to jnkn
        run: |
          OUTPUT=$(uv run jnkn blast ${{ steps.changes.outputs.files }})
          # Save output to a file to handle multiline JSON safely
          echo "$OUTPUT" > impact.json
          
          # Extract count for logic
          COUNT=$(echo "$OUTPUT" | jq .total_impacted_count)
          echo "count=$COUNT" >> $GITHUB_OUTPUT

      - name: Post PR Comment
        uses: actions/github-script@v6
        if: steps.changes.outputs.files != ''
        with:
          script: |
            const fs = require('fs');
            const impact = JSON.parse(fs.readFileSync('impact.json', 'utf8'));
            
            const count = impact.total_impacted_count;
            const emoji = count > 0 ? 'âš ï¸' : 'âœ…';
            
            let body = `### ${emoji} jnkn Impact Analysis\n`;
            body += `**Source Changes:** \`${impact.source_artifacts.join(', ')}\`\n`;
            body += `**Total Downstream Impact:** ${count} artifacts\n\n`;
            
            if (count > 0) {
              body += `| Type | Artifact |\n|---|---|\n`;
              // Add Code Impacts
              impact.breakdown.code.forEach(f => body += `| ğŸ’» Code | \`${f}\` |\n`);
              // Add Data/Infra (empty for now but ready)
              impact.breakdown.data.forEach(f => body += `| ğŸ“Š Data | \`${f}\` |\n`);
            } else {
              body += `No downstream dependencies found. Safe to merge!`;
            }
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });

      - name: Block Build on High Impact
        if: steps.blast.outputs.count > 10
        run: |
          echo "âŒ Too many artifacts impacted (${{ steps.blast.outputs.count }}). Blocking merge."
          exit 1